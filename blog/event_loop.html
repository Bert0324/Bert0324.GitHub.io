<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8" />
	<meta name="viewport" content="width=device-width, initial-scale=1.0" />
	<title>Bert's Blog</title>
	<meta name="keywords" content="blog,javascript,typescript,code,frontend">
	<meta name="description" content="bert huang's blog">
	<link rel="icon" href="/assets/favicon.ico"/>
	<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/github-markdown-css/4.0.0/github-markdown.min.css" integrity="sha512-Oy18vBnbSJkXTndr2n6lDMO5NN31UljR8e/ICzVPrGpSud4Gkckb8yUpqhKuUNoE+o9gAb4O/rAxxw1ojyUVzg==" crossorigin="anonymous" />
	<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.6.0/styles/a11y-light.min.css" integrity="sha512-PW96n2amVglidqEDLPUdjJ0zByhT20poSqWJYZRutR6CP2QH58k96WmorqNnC4QXnosNeqMJM8FR/93isIifDQ==" crossorigin="anonymous" />	
	<link rel="stylesheet" href="/blog/style.css" />
	<style>
		.markdown-body {
			box-sizing: border-box;
			min-width: 200px;
			max-width: 980px;
			margin: 0 auto;
			padding: 45px;
		}
	
		@media (max-width: 767px) {
			.markdown-body {
				padding: 15px;
			}
		}
	</style>
</head>

<body>
	<div>
		<div class="container"><div class="side-bar"><img class="avatar" src="/assets/avatar.jpeg"/><h1>Bert Huang</h1><p>一位兴趣广泛的前端程序员</p><nav><ul><li><a href="/blog/index.html">Index</a></li><li><a href="/blog/code.html">Code</a></li><li><a href="/blog/leetcode.html">LeetCode</a></li><li><a href="/blog/essay.html">Essay</a></li><li><a href="/blog/about.html">About</a></li></ul></nav><div id="social"><a href="https://github.com/Bert0324"><img class="social-avatar" src="https://github.githubassets.com/favicons/favicon.png"/></a><a href="https://www.facebook.com/people/Yuchen-Huang/100005315205237"><img class="social-avatar" src="/assets/facebook.png"/></a><a href="https://twitter.com/BertHuang5"><img class="social-avatar" src="/assets/twitter.png"/></a></div></div><div class="post-content"><div class="post-container"><div class="post-article"><article class="markdown-body">
		<div>
			<div id="toc"><div class="last-edit"><span>Last Commit: 2021-02-16 15:34:20</span></div><div id="toc-body"><p><strong>Table of Content</strong></p><ul><li><a href="#tasks and microtasks">tasks and microtasks</a></li><li><a href="#in browser">in browser</a></li><li><a href="#window event loop">window event loop</a></li><li><a href="#worker event loop">worker event loop</a></li><li><a href="#worklet event loop">worklet event loop</a></li><li><a href="#node.js">node.js</a></li><li><a href="#poll">poll</a></li><li><a href="#reference">reference</a></li></ul></div></div>
			<div>
			<h1 id='event loop'>
				Event Loop
			</h1>
		<p>JavaScripts&#39; biggest feature is its event loop, because of it, we can ignore details of threads and focus on those codes which can create real worth.</p>
<p>Event loop is responsible for executing the code, collecting and processing events, and executing queued sub-tasks.</p>

			<h2 id='tasks and microtasks'>
				Tasks and MicroTasks
			</h2>
		<p>A <strong>task</strong> is any JavaScript scheduled to be run by the standard mechanisms such as initially starting to execute a program, an event triggering a callback, and so forth.</p>
<p>Compared to task, <strong>microtasks</strong> will be executed until its queue is empty.</p>
<p>The sequence is like:</p>
<ul>
<li><strong>clear one task</strong> =&gt; <strong>clear all microtasks</strong> =&gt; <strong>clear one task</strong> =&gt; <strong>clear all microtasks</strong> ....</li>
</ul>
<p>Microtasks includes <code>Promise</code>, <code>queueMicrotask</code>, <code>MutationObserver</code> and <code>process.nextTick</code> on Node.js.</p>
<p>There is a typical codes to show it:</p>
<pre><code class="language-ts"><span class="hljs-built_in">setTimeout</span>(<span class="hljs-function"><span class="hljs-params">_</span> =&gt;</span> <span class="hljs-built_in">console</span>.log(<span class="hljs-number">4</span>));

<span class="hljs-keyword">new</span> <span class="hljs-built_in">Promise</span>(<span class="hljs-function"><span class="hljs-params">resolve</span> =&gt;</span> {
  resolve()
  <span class="hljs-built_in">console</span>.log(<span class="hljs-number">1</span>)
}).then(<span class="hljs-function"><span class="hljs-params">_</span> =&gt;</span> {
  <span class="hljs-built_in">console</span>.log(<span class="hljs-number">3</span>)
});

<span class="hljs-built_in">console</span>.log(<span class="hljs-number">2</span>);

<span class="hljs-comment">// 1 2 3 4</span>
</code></pre>

			<h2 id='in browser'>
				In Browser
			</h2>
		<p>In modern browsers, there are 3 different types of event loop is running.</p>

			<h3 id='window event loop'>
				Window Event Loop
			</h3>
		<p>It drives all of the windows sharing a similar origin.</p>

			<h3 id='worker event loop'>
				Worker event loop
			</h3>
		<p> It includes all forms of workers, such as web worker, shared workers and service workers. Workers are kept in one or more agents that are separate from the &quot;main&quot; code; the browser may use a single event loop for all of the workers of a given type or may use multiple event loops to handle them.</p>

			<h3 id='worklet event loop'>
				Worklet Event Loop
			</h3>
		<p>A worklet event loop is the event loop used to drive agents which run the code for the workelets for a given agent. This includes worklets of type Worklet, AudioWorklet, and PaintWorklet.</p>

			<h2 id='node.js'>
				Node.js
			</h2>
		<p>In Node.js, event loop is quite different from browsers. As it don&#39;t have render tasks and have more I/O tasks.</p>
<p>When Node.js starts, it initializes the Event loop, processes the provided input script which may make async API calls, then begins processing the Event loop.</p>
<p>There is only one thread and that is the thread Event loop runs on. Event loop works in a cyclical order, with different phases. The order of operation of Event loop is shown below.</p>
<img src='https://raw.githubusercontent.com/Bert0324/code-playground/master/assets/node_event_loop.png' width="400"/>

<ul>
<li><strong>timers</strong>: this phase executes callbacks scheduled by setTimeout() and setInterval().</li>
<li><strong>pending callbacks</strong>: executes I/O callbacks deferred to the next loop iteration.</li>
<li><strong>idle, prepare</strong>: only used internally.</li>
<li><strong>poll</strong>: retrieve new I/O events; execute I/O related callbacks (almost all with the exception of close callbacks, the ones scheduled by timers, and setImmediate()); node will block here when appropriate.</li>
<li><strong>check</strong>: setImmediate() callbacks are invoked here.</li>
<li><strong>close callbacks</strong>: some close callbacks, e.g. socket.on(&#39;close&#39;, ...).</li>
</ul>

			<h3 id='poll'>
				Poll
			</h3>
		<p>The poll phase has two main functions:</p>
<ol>
<li>Calculating how long it should block and poll for I/O, then</li>
<li>Processing events in the poll queue.</li>
</ol>
<p>When the event loop enters the poll phase and there are no timers scheduled, one of two things will happen:</p>
<ul>
<li><p>If the poll queue is not empty, the event loop will iterate through its queue of callbacks executing them synchronously until either the queue has been exhausted, or the system-dependent hard limit is reached.</p>
</li>
<li><p>If the poll queue is empty, one of two more things will happen:</p>
<ol>
<li><p>If scripts have been scheduled by setImmediate(), the event loop will end the poll phase and continue to the check phase to execute those scheduled scripts.</p>
</li>
<li><p>If scripts have not been scheduled by setImmediate(), the event loop will wait for callbacks to be added to the queue, then execute them immediately.</p>
</li>
</ol>
</li>
</ul>
<p>Once the poll queue is empty the event loop will check for timers whose time thresholds have been reached. If one or more timers are ready, the event loop will wrap back to the timers phase to execute those timers&#39; callbacks.</p>

			<h2 id='reference'>
				Reference
			</h2>
		<ul>
<li><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/EventLoop">https://developer.mozilla.org/en-US/docs/Web/JavaScript/EventLoop</a></li>
<li><a href="https://developer.mozilla.org/en-US/docs/Web/API/HTML_DOM_API/Microtask_guide/In_depth">https://developer.mozilla.org/en-US/docs/Web/API/HTML_DOM_API/Microtask_guide/In_depth</a></li>
<li><a href="https://javascript.info/microtask-queue">https://javascript.info/microtask-queue</a></li>
<li><a href="https://nodejs.org/en/docs/guides/event-loop-timers-and-nexttick/">https://nodejs.org/en/docs/guides/event-loop-timers-and-nexttick/</a></li>
<li><a href="https://stackoverflow.com/questions/47724811/why-setimmediate-execute-before-fs-readfile-in-nodejs-event-loops-works">https://stackoverflow.com/questions/47724811/why-setimmediate-execute-before-fs-readfile-in-nodejs-event-loops-works</a></li>
</ul>
</div>
		</div>
	</article></div></div></div></div>
	</div>
</body>

<script>
	const body = document.getElementsByClassName('markdown-body')[0];
	const initComments = () => {
		if (![
			'/',
			'/blog/index.html', 
			'/blog/code.html', 
			'/blog/leetcode.html', 
			'/blog/essay.html',
			'/blog/about.html'
		].includes(window.location.pathname)) {
			const root = document.createElement('div');
			root.id = 'fb-root';
			root.className = 'post-comments';
			const comments = document.createElement('div');
			comments.className = 'fb-comments';
			comments['data-href'] = window.location.href;
			comments['data-numposts'] = '5';
			root.appendChild(comments);
			body.appendChild(root);
		}
	};
	const changeComments = () => {
		const title = body.getElementsByTagName('h1')[0];
		if (title) {
			document.title = title.innerText;
		}
	};
	if (body) {
		changeComments();
		initComments();
	}
</script>
<script async defer crossorigin="anonymous" src="https://connect.facebook.net/en_US/sdk.js#xfbml=1&version=v9.0" nonce="BSCiWiHI"></script>
<script async src="https://www.googletagmanager.com/gtag/js?id=G-0SEZ9KRGY7"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-0SEZ9KRGY7');
</script>
</html>