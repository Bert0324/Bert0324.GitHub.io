<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8" />
	<meta name="viewport" content="width=device-width, initial-scale=1.0" />
	<title>Bert's Blog</title>
	<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/github-markdown-css/4.0.0/github-markdown.min.css" integrity="sha512-Oy18vBnbSJkXTndr2n6lDMO5NN31UljR8e/ICzVPrGpSud4Gkckb8yUpqhKuUNoE+o9gAb4O/rAxxw1ojyUVzg==" crossorigin="anonymous" />
	<link rel="stylesheet/less" type="text/css" href="/blog/style.less" />
	<script src="//cdn.jsdelivr.net/npm/less@3.13" ></script>
	<style>
		.markdown-body {
			box-sizing: border-box;
			min-width: 200px;
			max-width: 980px;
			margin: 0 auto;
			padding: 45px;
		}
	
		@media (max-width: 767px) {
			.markdown-body {
				padding: 15px;
			}
		}
	</style>
</head>

<body>
	<div><div><article class="markdown-body"><h1 id="service-worker">Service Worker</h1>
<h2 id="permission">Permission</h2>
<p>Compared to Web Worker, Service Worker has higher permission.</p>
<table>
    <thead>
    <tr>
        <th>operation</th>
        <th>Web Worker</th>
        <th>Service Worker</th>
    </tr>
    </thead>
    <tbody>
    <tr>
        <td>close current tag</td>
        <td>close process</td>
        <td>keep process</td>
    </tr>
    <tr>
        <td>agent solicitation</td>
        <td>accessible</td>
        <td>unaccessible</td>
    </tr>
    <tr>
        <td>Cache Storage</td>
        <td>unaccessible</td>
        <td>accessible</td>
    </tr>
    <tr>
        <td>backgroud push</td>
        <td>no</td>
        <td>yes</td>
    </tr>
    <tr>
        <td>background sync</td>
        <td>no</td>
        <td>yes</td>
    </tr>
    <tr>
        <td>security requirement</td>
        <td>none</td>
        <td>must be https or localhost</td>
    </tr>
    </tbody>
</table>

<h2 id="basic-use">basic use</h2>
<p>First of all, regist this Service Worker in main thread.</p>
<p>Next, in Service Worker script, in <code>install</code> event, define the files that needs to be save in caches, which is a read-only property returns the CacheStorage object associated with the service worker.</p>
<p>Then, in <code>fetch</code> event, get caches to load instead requesting to server.</p>
<pre><code class="language-js">//main thread regist
if (&#39;serviceWorker&#39; in navigator) {
  navigator.serviceWorker.register(&#39;/sw.js&#39;).then(function(registration) {
    // Registration was successful
    console.log(&#39;ServiceWorker registration successful with scope: &#39;,    registration.scope);
  }).catch(function(err) {
    // registration failed :(
    console.log(&#39;ServiceWorker registration failed: &#39;, err);
  });
}
//sw.js
const cacheName = &#39;v1&#39;;
var assetsToCache = [   //the path of files that needs to be saved in caches
  &#39;/styles/main.css&#39;,
  &#39;/script/main.js&#39;
];
self.addEventListener(&#39;install&#39;, function(event) {
  event.waitUntil(
    caches.open(cacheName).then(function(cache) {
      return cache.addAll(assetsToCache);   //request files resource and save in caches
    }).then(function() {
      return self.skipWaiting();
    });
});
//intercept GET and check in caches  
self.addEventListener(&#39;fetch&#39;, function(event) {
  var requestUrl = new URL(event.request.url);
  if (requestUrl.origin === location.origin) {
      if (requestUrl.pathname === &#39;/&#39;) {
      event.respondWith(
        caches.open(cacheName).then(function(cache) {
          return fetch(event.request).then(function(networkResponse) {
            cache.put(event.request, networkResponse.clone());
            return networkResponse;
          }).catch(function() {
            return cache.match(event.request);
          });
        })
      );
    }
  }
  event.respondWith(
    caches.match(event.request).then(function(response) {
      return response || fetch(event.request);
    })
  );
});
</code></pre>
<p>About <code>caches</code> API, see <a href="https://developer.mozilla.org/en-US/docs/Web/API/WindowOrWorkerGlobalScope/caches">here</a>.</p>
<h2 id="some-tips">Some tips</h2>
<ol>
<li><p>only <code>GET</code> request can be saved</p>
</li>
<li><p>Service Worker can receive fetch events in same path. For example, if the Service Worker file is in 
<code>/sub</code>, it can&#39;t get fetch event in path <code>/</code>.</p>
</li>
<li><p>caches size has limit. check <a href="https://developers.google.com/web/fundamentals/instant-and-offline/web-storage/offline-for-pwa?">here</a>.</p>
</li>
<li><p>By default, Service Work will update the file each 24 hours.</p>
</li>
</ol>
<h2 id="workbox">workbox</h2>
<p>Via Google&#39;s workbox, we don&#39;t need to write lots of Service Worker code to save caches and update files&#39; version.
In create-react-app, it will be installed automatically. <a href="https://developers.google.com/web/tools/workbox/">workbox</a>.</p>
<p>If you use it to create React project, there is a file named <code>service-worker.js</code> and <code>precache-manifest.[hash].js</code> in the <code>build</code>, 
As below:</p>
<pre><code class="language-js">//import workbox script
importScripts(&quot;https://storage.googleapis.com/workbox-cdn/releases/4.3.1/workbox-sw.js&quot;);
//import precache-manifest
importScripts(
  &quot;/precache-manifest.2cd68ada852c92872b4d0460d6667f6f.js&quot;
);

self.addEventListener(&#39;message&#39;, (event) =&gt; {
  if (event.data &amp;&amp; event.data.type === &#39;SKIP_WAITING&#39;) {
    self.skipWaiting();
  }
});

workbox.core.clientsClaim();

self.__precacheManifest = [].concat(self.__precacheManifest || []);
//declare the file that needs to be saved in caches
workbox.precaching.precacheAndRoute(self.__precacheManifest, {});

workbox.routing.registerNavigationRoute(workbox.precaching.getCacheKeyForURL(&quot;/index.html&quot;), {
  
  blacklist: [/^\/_/,/\/[^\/]+\.[^\/]+$/],
});
</code></pre>
<p>And in precache-manifest we can see:</p>
<pre><code class="language-json">self.__precacheManifest = (self.__precacheManifest || []).concat([
  {
    &quot;revision&quot;: &quot;1a3b75ef22b2e98cc7c9ebaba56d802b&quot;,
    &quot;url&quot;: &quot;/index.html&quot;
  },
  {
    &quot;revision&quot;: &quot;7558c4b96fbf38782a1f&quot;,
    &quot;url&quot;: &quot;/static/css/main.237a1b42.chunk.css&quot;
  },
  {
    &quot;revision&quot;: &quot;59d8ab21f38e8a1d3f64&quot;,
    &quot;url&quot;: &quot;/static/js/0.079d22b2.chunk.js&quot;
  },
  {
    &quot;revision&quot;: &quot;01ad347310a4099197cb&quot;,
    &quot;url&quot;: &quot;/static/js/1.5cc2483c.chunk.js&quot;
  },
  {
    &quot;revision&quot;: &quot;a1c05097c251637a6568&quot;,
    &quot;url&quot;: &quot;/static/js/4.3d58efea.chunk.js&quot;
  },
  {
    &quot;revision&quot;: &quot;7558c4b96fbf38782a1f&quot;,
    &quot;url&quot;: &quot;/static/js/main.d8fc5b5b.chunk.js&quot;
  },
  {
    &quot;revision&quot;: &quot;5ad2e17ec9d2caecd451&quot;,
    &quot;url&quot;: &quot;/static/js/runtime~main.3ac4b0b3.js&quot;
  }
]);
</code></pre>
<p>The <code>url</code> is files&#39; path, and the <code>revision</code> is the files&#39; content hash value, which will be changed if files is changed.
In this way, workbox can know whether the file is updated.</p>
<h2 id="end">End</h2>
<p>With the development of PWA, I believe Web App is able to be closed to Native App in many respects.</p>
<p>If there is some wrongs, welcome to leave a message.</p>
</article></div></div>
</body>

</html>