<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8" />
	<meta name="viewport" content="width=device-width, initial-scale=1.0" />
	<title>Bert's Blog</title>
	<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/github-markdown-css/4.0.0/github-markdown.min.css" integrity="sha512-Oy18vBnbSJkXTndr2n6lDMO5NN31UljR8e/ICzVPrGpSud4Gkckb8yUpqhKuUNoE+o9gAb4O/rAxxw1ojyUVzg==" crossorigin="anonymous" />
	<link rel="stylesheet/less" type="text/css" href="/blog/style.less" />
	<script src="//cdn.jsdelivr.net/npm/less@3.13" ></script>
	<style>
		.markdown-body {
			box-sizing: border-box;
			min-width: 200px;
			max-width: 980px;
			margin: 0 auto;
			padding: 45px;
		}
	
		@media (max-width: 767px) {
			.markdown-body {
				padding: 15px;
			}
		}
	</style>
</head>

<body>
	<div><div><article class="markdown-body"><h1 id="react-reconciliation">React Reconciliation</h1>
<p>In React, the most significant feature is Virtual DOM which is based on Diff Algorithm.</p>
<p>By understanding diff in React, we are able to write a React Application with higher performance.</p>
<h2 id="diff-strategy">Diff Strategy</h2>
<p>There is an easiest diff function to traverse an tree by recursion as below:</p>
<pre><code class="language-ts">const result = [];
// compare sub nodes
const diffLeafs = function (beforeLeaf, afterLeaf) {
    // get the max length of last tree and next tree
    let count = Math.max(beforeLeaf.children.length, afterLeaf.children.length);
    for (let i = 0; i &lt; count; i++) {
        const beforeTag = beforeLeaf.children[i];
        const afterTag = afterLeaf.children[i];
        // add afterTag node
        if (beforeTag === undefined) {
            result.push({ type: &quot;add&quot;, element: afterTag });
            // remove beforeTag node
        } else if (afterTag === undefined) {
            result.push({ type: &quot;remove&quot;, element: beforeTag });
            // when node type has changed, removing beforeTag node, add afterTag node
        } else if (beforeTag.tagName !== afterTag.tagName) {
            result.push({ type: &quot;remove&quot;, element: beforeTag });
            result.push({ type: &quot;add&quot;, element: afterTag });
            // when node type is the same, changing its content
        } else if (beforeTag.innerHTML !== afterTag.innerHTML) {
            if (beforeTag.children.length === 0) {
                result.push({
                    type: &quot;changed&quot;,
                    beforeElement: beforeTag,
                    afterElement: afterTag,
                    html: afterTag.innerHTML
                });
            } else {
                // recursion comparison
                diffLeafs(beforeTag, afterTag);
            }
        }
    }
    return result;
}
</code></pre>
<p>It needs to traverse two trees and their children, therefore its time complexity is O(n^3), which means it is too expensive to be used in practice.</p>
<p>React use its advanced diff strategy to reduce the time complexity to O(n), which is based on 3 strategy as below:</p>
<h3 id="tree-diff">Tree Diff</h3>
<p>In practice, it&#39;s rare to operate DOM crossing its tree level.</p>
<p>In this way, when moving an element to another element in different level, React won&#39;t move the element, instead, React will remove it and recreate it. The process is as below:</p>
<img src='https://raw.githubusercontent.com/Bert0324/code-playground/master/assets/../' width="400"/>

<p>tips:</p>
<ul>
<li>Keep the structure of DOM stable, changing the tree structure as less as possible.</li>
<li>When we need to remove and add a node frequently, we can use CSS to hide it, instead of removing it from the DOM tree.</li>
</ul>
<h3 id="component-diff">Component Diff</h3>
<p>React assumes that the same components will generate the same DOM structure, in contrast, different components will generate a different DOM structure.</p>
<p>The component like as below is that we need to avoid when we using React:</p>
<img src='https://raw.githubusercontent.com/Bert0324/code-playground/master/assets/../' width="400"/>

<p>tips:</p>
<ul>
<li>use <code>shouldComponentUpdate</code> or <code>React.memo</code> (<code>PureComponent</code>) to avoid unnecessary rendering.</li>
<li>UI with the similar structure can be wrote as a component.</li>
</ul>
<h3 id="element-diff">Element Diff</h3>
<p>For elements they are in the one level and same list, they can be recognized by an unique key.</p>
<p>For those elements they changed their position, React use a principle <code>previousIndex &gt; currentIndex =&gt; Not Move</code> to judge which elements need to be moved.</p>
<img src='https://raw.githubusercontent.com/Bert0324/code-playground/master/assets/../' width="400"/>

<p>In this situation, all elements except D will be moved. Obviously, it&#39;s a huge cost of performance.</p>
<p>tips:</p>
<ul>
<li>add a real unique key in list.</li>
<li>avoid to shift the last element in a list to the head.</li>
</ul>
<h3 id="more-optimization">More Optimization</h3>
<h4 id="anonymous-function-in-jsx">Anonymous function in JSX</h4>
<p>if writing anonymous function in JSX, every time React rerender, it will re-execute the anonymous function.</p>
<p>Because React uses <code>===</code> to compare <code>props</code>:</p>
<pre><code class="language-js">(() =&gt; {}) === (() =&gt; {}); // false
</code></pre>
<p><code>Function</code> object in JS is reference type, in this way, even the same anonymous function will be treated as different object to trigger re-execute.</p>
<p>For those components rendered frequently, we&#39;d better to use <code>useCallback</code> or <code>useMemo</code> to reduce its render times.</p>
<h2 id="reference">Reference</h2>
<ul>
<li><a href="https://reactjs.org/docs/reconciliation.html">https://reactjs.org/docs/reconciliation.html</a></li>
<li><a href="https://www.jianshu.com/p/6e9c91c62d0f">https://www.jianshu.com/p/6e9c91c62d0f</a></li>
<li><a href="https://www.cronj.com/blog/diff-algorithm-implemented-reactjs/">https://www.cronj.com/blog/diff-algorithm-implemented-reactjs/</a></li>
<li><a href="https://zhuanlan.zhihu.com/p/20346379">https://zhuanlan.zhihu.com/p/20346379</a></li>
</ul>
</article></div></div>
</body>

</html>