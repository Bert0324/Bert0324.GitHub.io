<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1"><title>Bert's Blog</title><meta name="keywords" content="blog,javascript,typescript,code,frontend"><meta name="description" content="bert huang's blog"><link rel="icon" href="/assets/favicon.ico"><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/github-markdown-css/4.0.0/github-markdown.min.css" integrity="sha512-Oy18vBnbSJkXTndr2n6lDMO5NN31UljR8e/ICzVPrGpSud4Gkckb8yUpqhKuUNoE+o9gAb4O/rAxxw1ojyUVzg==" crossorigin="anonymous"><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.6.0/styles/a11y-light.min.css" integrity="sha512-PW96n2amVglidqEDLPUdjJ0zByhT20poSqWJYZRutR6CP2QH58k96WmorqNnC4QXnosNeqMJM8FR/93isIifDQ==" crossorigin="anonymous"><link rel="stylesheet" href="/blog/style.css"><style>.markdown-body{box-sizing:border-box;min-width:200px;max-width:980px;margin:0 auto;padding:45px}@media (max-width:767px){.markdown-body{padding:15px}}</style></head><body><div><div class="container"><div class="side-bar"><img class="avatar" src="/assets/avatar.jpeg"><h1>Bert Huang</h1><p>一位兴趣广泛的前端程序员</p><nav><ul><li><a href="/blog/index.html">Index</a></li><li><a href="/blog/code.html">Code</a></li><li><a href="/blog/leetcode.html">LeetCode</a></li><li><a href="/blog/essay.html">Essay</a></li><li><a href="/blog/about.html">About</a></li></ul></nav><div id="social"><a href="https://github.com/Bert0324"><img class="social-avatar" src="https://github.githubassets.com/favicons/favicon.png"></a><a href="https://www.facebook.com/people/Yuchen-Huang/100005315205237"><img class="social-avatar" src="/assets/facebook.png"></a><a href="https://twitter.com/BertHuang5"><img class="social-avatar" src="/assets/twitter.png"></a></div><div class="views-count"><p id="busuanzi_container_site_uv" style="display:inline">total viewers: <span id="busuanzi_value_site_uv"></span></p></div></div><div class="post-content"><div class="post-container"><div id="particles-js" style="position:fixed;height:100vh;width:100vw;z-index:-99"></div><div class="post-article"><article class="markdown-body"><div><div id="toc"><div class="last-edit"><p>Last Commit: 2021-02-17 16:09:13</p><p id="busuanzi_container_page_pv">views: <span id="busuanzi_value_page_pv"></span></p></div><div id="toc-body"><p><strong>Table of Content</strong></p><ul><li><a href="#diff%20strategy">diff strategy</a></li><ul><li><a href="#tree%20diff">tree diff</a></li><li><a href="#component%20diff">component diff</a></li><li><a href="#element%20diff">element diff</a></li><li><a href="#more%20optimization">more optimization</a></li><ul><li><a href="#anonymous%20function%20in%20jsx">anonymous function in jsx</a></li></ul></ul><li><a href="#reference">reference</a></li></ul></div></div><div><h1 id="react%20reconciliation">React Reconciliation</h1><p>In React, the most significant feature is Virtual DOM which is based on Diff Algorithm.</p><p>By understanding diff in React, we are able to write a React Application with higher performance.</p><h2 id="diff%20strategy">Diff Strategy</h2><p>There is an easiest diff function to traverse an tree by recursion as below:</p><pre><code class="language-ts"><span class="hljs-keyword">const</span> result = [];
<span class="hljs-comment">// compare sub nodes</span>
<span class="hljs-keyword">const</span> diffLeafs = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">beforeLeaf, afterLeaf</span>) </span>{
    <span class="hljs-comment">// get the max length of last tree and next tree</span>
    <span class="hljs-keyword">let</span> count = <span class="hljs-built_in">Math</span>.max(beforeLeaf.children.length, afterLeaf.children.length);
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; count; i++) {
        <span class="hljs-keyword">const</span> beforeTag = beforeLeaf.children[i];
        <span class="hljs-keyword">const</span> afterTag = afterLeaf.children[i];
        <span class="hljs-comment">// add afterTag node</span>
        <span class="hljs-keyword">if</span> (beforeTag === <span class="hljs-literal">undefined</span>) {
            result.push({ <span class="hljs-attr">type</span>: <span class="hljs-string">&quot;add&quot;</span>, <span class="hljs-attr">element</span>: afterTag });
            <span class="hljs-comment">// remove beforeTag node</span>
        } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (afterTag === <span class="hljs-literal">undefined</span>) {
            result.push({ <span class="hljs-attr">type</span>: <span class="hljs-string">&quot;remove&quot;</span>, <span class="hljs-attr">element</span>: beforeTag });
            <span class="hljs-comment">// when node type has changed, removing beforeTag node, add afterTag node</span>
        } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (beforeTag.tagName !== afterTag.tagName) {
            result.push({ <span class="hljs-attr">type</span>: <span class="hljs-string">&quot;remove&quot;</span>, <span class="hljs-attr">element</span>: beforeTag });
            result.push({ <span class="hljs-attr">type</span>: <span class="hljs-string">&quot;add&quot;</span>, <span class="hljs-attr">element</span>: afterTag });
            <span class="hljs-comment">// when node type is the same, changing its content</span>
        } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (beforeTag.innerHTML !== afterTag.innerHTML) {
            <span class="hljs-keyword">if</span> (beforeTag.children.length === <span class="hljs-number">0</span>) {
                result.push({
                    <span class="hljs-attr">type</span>: <span class="hljs-string">&quot;changed&quot;</span>,
                    <span class="hljs-attr">beforeElement</span>: beforeTag,
                    <span class="hljs-attr">afterElement</span>: afterTag,
                    <span class="hljs-attr">html</span>: afterTag.innerHTML
                });
            } <span class="hljs-keyword">else</span> {
                <span class="hljs-comment">// recursion comparison</span>
                diffLeafs(beforeTag, afterTag);
            }
        }
    }
    <span class="hljs-keyword">return</span> result;
}
</code></pre><p>It needs to traverse two trees and their children, therefore its time complexity is O(n^3), which means it is too expensive to be used in practice.</p><p>React use its advanced diff strategy to reduce the time complexity to O(n), which is based on 3 strategy as below:</p><h3 id="tree%20diff">Tree Diff</h3><p>In practice, it&#39;s rare to operate DOM crossing its tree level.</p><p>In this way, when moving an element to another element in different level, React won&#39;t move the element, instead, React will remove it and recreate it. The process is as below:</p><img src="https://raw.githubusercontent.com/Bert0324/code-playground/master/assets/tree_diff.png" width="400"><p>tips:</p><ul><li>Keep the structure of DOM stable, changing the tree structure as less as possible.</li><li>When we need to remove and add a node frequently, we can use CSS to hide it, instead of removing it from the DOM tree.</li></ul><h3 id="component%20diff">Component Diff</h3><p>React assumes that the same components will generate the same DOM structure, in contrast, different components will generate a different DOM structure.</p><p>The component like as below is that we need to avoid when we using React:</p><img src="https://raw.githubusercontent.com/Bert0324/code-playground/master/assets/com_diff.png" width="400"><p>tips:</p><ul><li>use <code>shouldComponentUpdate</code> or <code>React.memo</code> (<code>PureComponent</code>) to avoid unnecessary rendering.</li><li>UI with the similar structure can be wrote as a component.</li></ul><h3 id="element%20diff">Element Diff</h3><p>For elements they are in the one level and same list, they can be recognized by an unique key.</p><p>For those elements they changed their position, React use a principle <code>previousIndex &gt; currentIndex =&gt; Not Move</code> to judge which elements need to be moved.</p><img src="https://raw.githubusercontent.com/Bert0324/code-playground/master/assets/element_diff.png" width="400"><p>In this situation, all elements except D will be moved. Obviously, it&#39;s a huge cost of performance.</p><p>tips:</p><ul><li>add a real unique key in list.</li><li>avoid to shift the last element in a list to the head.</li></ul><h3 id="more%20optimization">More Optimization</h3><h4 id="anonymous%20function%20in%20jsx">Anonymous function in JSX</h4><p>if writing anonymous function in JSX, every time React rerender, it will re-execute the anonymous function.</p><p>Because React uses <code>===</code> to compare <code>props</code>:</p><pre><code class="language-js">(<span class="hljs-function">() =&gt;</span> {}) === (<span class="hljs-function">() =&gt;</span> {}); <span class="hljs-comment">// false</span>
</code></pre><p><code>Function</code> object in JS is reference type, in this way, even the same anonymous function will be treated as different object to trigger re-execute.</p><p>For those components rendered frequently, we&#39;d better to use <code>useCallback</code> or <code>useMemo</code> to reduce its render times.</p><h2 id="reference">Reference</h2><ul><li><a href="https://reactjs.org/docs/reconciliation.html">https://reactjs.org/docs/reconciliation.html</a></li><li><a href="https://www.jianshu.com/p/6e9c91c62d0f">https://www.jianshu.com/p/6e9c91c62d0f</a></li><li><a href="https://www.cronj.com/blog/diff-algorithm-implemented-reactjs/">https://www.cronj.com/blog/diff-algorithm-implemented-reactjs/</a></li><li><a href="https://zhuanlan.zhihu.com/p/20346379">https://zhuanlan.zhihu.com/p/20346379</a></li></ul></div></div></article></div></div><div id="reminder" style="display:none">Facebook Comments Service is unavailable</div></div></div></div></body><script src="https://cdn.jsdelivr.net/npm/particles.js@2.0.0/particles.min.js"></script><script>particlesJS("particles-js",{particles:{number:{value:80,density:{enable:!0,value_area:1600}},color:{value:"#ffffff"},shape:{type:"circle",stroke:{width:0,color:"#000000"},polygon:{nb_sides:5},image:{src:"img/github.svg",width:100,height:100}},opacity:{value:.5,random:!1,anim:{enable:!1,speed:1,opacity_min:.1,sync:!1}},size:{value:3,random:!0,anim:{enable:!1,speed:40,size_min:.1,sync:!1}},line_linked:{enable:!0,distance:150,color:"#000000",opacity:.4,width:1},move:{enable:!0,speed:6,direction:"none",random:!1,straight:!1,out_mode:"out",bounce:!1,attract:{enable:!1,rotateX:600,rotateY:1200}}},interactivity:{detect_on:"canvas",events:{onhover:{enable:!0,mode:"repulse"},onclick:{enable:!0,mode:"push"},resize:!0},modes:{grab:{distance:400,line_linked:{opacity:1}},bubble:{distance:400,size:40,duration:2,opacity:8,speed:3},repulse:{distance:200,duration:.4},push:{particles_nb:4},remove:{particles_nb:2}}},retina_detect:!0})</script><script>const checkFacebookAvailable=()=>new Promise((e,t)=>{const o=new Image;o.src="https://www.facebook.com/images/facebook.png",o.onerror=e=>t(e),o.onload=()=>e(),o.style.display="none",body.append(o),setTimeout(()=>t(),5e3)}),body=document.getElementsByClassName("markdown-body")[0],initComments=()=>{["/","/blog/index.html","/blog/code.html","/blog/leetcode.html","/blog/essay.html","/blog/about.html"].includes(window.location.pathname)||checkFacebookAvailable().then(()=>{const e=document.createElement("div");e.id="fb-root",e.className="post-comments";const t=document.createElement("div");t.className="fb-comments",t.setAttribute("data-href",window.location.href),t.setAttribute("data-numposts","5"),t.setAttribute("data-width","100%"),e.appendChild(t),body.appendChild(e)}).catch(()=>{const e=document.createElement("div");e.className="reminder",e.innerText="Facebook Comments Service is unavailable",body.appendChild(e)})},changeComments=()=>{var e=body.getElementsByTagName("h1")[0];e&&(document.title=e.innerText)};body&&(changeComments(),initComments())</script><script async defer="defer" crossorigin="anonymous" src="https://connect.facebook.net/en_US/sdk.js#xfbml=1&version=v9.0" nonce="BSCiWiHI"></script><script async src="https://www.googletagmanager.com/gtag/js?id=G-0SEZ9KRGY7"></script><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><script>function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","G-0SEZ9KRGY7")</script></html>