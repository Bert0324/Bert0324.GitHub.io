<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8" />
	<meta name="viewport" content="width=device-width, initial-scale=1.0" />
	<title>Bert's Blog</title>
	<meta name="keywords" content="blog,javascript,typescript,code,frontend">
	<meta name="description" content="bert huang's blog">
	<link rel="icon" href="/assets/favicon.ico"/>
	<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/github-markdown-css/4.0.0/github-markdown.min.css" integrity="sha512-Oy18vBnbSJkXTndr2n6lDMO5NN31UljR8e/ICzVPrGpSud4Gkckb8yUpqhKuUNoE+o9gAb4O/rAxxw1ojyUVzg==" crossorigin="anonymous" />
	<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.6.0/styles/a11y-light.min.css" integrity="sha512-PW96n2amVglidqEDLPUdjJ0zByhT20poSqWJYZRutR6CP2QH58k96WmorqNnC4QXnosNeqMJM8FR/93isIifDQ==" crossorigin="anonymous" />	
	<link rel="stylesheet" href="/blog/style.css" />
	<style>
		.markdown-body {
			box-sizing: border-box;
			min-width: 200px;
			max-width: 980px;
			margin: 0 auto;
			padding: 45px;
		}
	
		@media (max-width: 767px) {
			.markdown-body {
				padding: 15px;
			}
		}
	</style>
</head>

<body>
	<div>
		<div class="container"><div class="side-bar"><img class="avatar" src="/assets/avatar.jpeg"/><h1>Bert Huang</h1><p>一位兴趣广泛的前端程序员</p><nav><ul><li><a href="/blog/index.html">Index</a></li><li><a href="/blog/code.html">Code</a></li><li><a href="/blog/leetcode.html">LeetCode</a></li><li><a href="/blog/essay.html">Essay</a></li><li><a href="/blog/about.html">About</a></li></ul></nav><div id="social"><a href="https://github.com/Bert0324"><img class="social-avatar" src="https://github.githubassets.com/favicons/favicon.png"/></a><a href="https://www.facebook.com/people/Yuchen-Huang/100005315205237"><img class="social-avatar" src="/assets/facebook.png"/></a><a href="https://twitter.com/BertHuang5"><img class="social-avatar" src="/assets/twitter.png"/></a></div></div><div class="post-content"><div class="post-container"><div class="post-article"><article class="markdown-body">
		<div>
			<div id="toc"><div class="last-edit"><span>Last Commit: 2021-02-16 15:34:20</span></div><div id="toc-body"><p><strong>Table of Content</strong></p><ul><li><a href="#advantages of ssr">advantages of ssr</a></li><li><a href="#why is ssr possible in react">why is ssr possible in react</a></li><li><a href="#key points">key points</a></li><li><a href="#ssr in react">ssr in react</a></li><li><a href="#static file server">static file server</a></li><li><a href="#frontend">frontend</a></li><li><a href="#compile server code">compile server code</a></li><li><a href="#end">end</a></li></ul></div></div>
			<div>
			<h1 id='ssr'>
				SSR
			</h1>
		
			<h2 id='advantages of ssr'>
				Advantages of SSR
			</h2>
		<ol>
<li><p>For me, the biggest reason is SEO. Although now Google started supporting JS in searching, 
but pure HTML is always better for SEO. </p>
</li>
<li><p>Shorten first page response time. Don&#39;t need to waste time in downloading a lots of js files and css files to 
show the page, users can see the page quickly.</p>
</li>
</ol>

			<h2 id='why is ssr possible in react'>
				Why is SSR possible in React
			</h2>
		<p>I think the main reason is the virtual DOM and node.js. Obviously, in node.js, there is no DOM object. React does&#39;t operate 
DOM directly too, it use VDOM to generate and change real DOM. So, in server side, node.js is able to generate a HTML template,
provided that there is no operation involving Browser Object or DOM.</p>

			<h2 id='key points'>
				Key Points
			</h2>
		<p>We use Node.js in server side to generate a HTML instead of a Browser JS engine, there are some things I think is worth to notice:</p>
<ol>
<li><p>No direct DOM and Browser Object operation.</p>
</li>
<li><p>Each request has its own status, instead of sharing.</p>
</li>
<li><p>Transfer Browser&#39;s JS to Node.js</p>
</li>
</ol>

			<h2 id='ssr in react'>
				SSR in React
			</h2>
		
			<h3 id='static file server'>
				static file server
			</h3>
		<p>I will start two servers, one is in charge of restful API, and another is charge of static files and SSR.
React has its specific API for SSR. The static files server based on express like as below:</p>
<pre><code class="language-js"><span class="hljs-keyword">import</span> React <span class="hljs-keyword">from</span> <span class="hljs-string">&quot;react&quot;</span>;
<span class="hljs-keyword">import</span> ReactDomServer <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;react-dom/server&#x27;</span>;
<span class="hljs-keyword">import</span> App <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;../src/app&#x27;</span>
<span class="hljs-keyword">import</span> express <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;express&#x27;</span>;
<span class="hljs-keyword">import</span> path <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;path&#x27;</span>;
<span class="hljs-keyword">import</span> fs <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;fs&#x27;</span>;
<span class="hljs-keyword">const</span> app = express();
<span class="hljs-keyword">const</span> port = <span class="hljs-number">3000</span>;


<span class="hljs-keyword">const</span> SSR = <span class="hljs-function">(<span class="hljs-params">req, res, next</span>)=&gt;</span>{
    <span class="hljs-keyword">if</span> (req.url === <span class="hljs-string">&#x27;/index&#x27;</span> || req.url === <span class="hljs-string">&#x27;/&#x27;</span>){
        fs.readFile(path.resolve(<span class="hljs-string">&#x27;./build/index.html&#x27;</span>), <span class="hljs-string">&#x27;utf8&#x27;</span>, <span class="hljs-function">(<span class="hljs-params">err, data</span>)=&gt;</span>{
            <span class="hljs-keyword">if</span> (err){
                <span class="hljs-built_in">console</span>.log(err);
                <span class="hljs-keyword">return</span> res.status(<span class="hljs-number">500</span>).send(<span class="hljs-string">&#x27;Server Error&#x27;</span>);
            } <span class="hljs-keyword">else</span> {
                <span class="hljs-keyword">return</span> res.send(data.replace(<span class="hljs-string">&#x27;&lt;div id=&quot;root&quot;&gt;&lt;/div&gt;&#x27;</span>,
                        <span class="hljs-string">`&lt;div id=&quot;root&quot;&gt;<span class="hljs-subst">${ReactDomServer.renderToString(&lt;App url={<span class="hljs-string">&#x27;/index&#x27;</span>} env={<span class="hljs-string">&#x27;node&#x27;</span>}<span class="hljs-regexp">/&gt;)}&lt;/</span>div&gt;<span class="hljs-string">`))
            }
        })
    } else {
        return next();
    }
};
app.use(&#x27;/media&#x27;, express.static(path.resolve(&#x27;media&#x27;)));
app.use(SSR);
app.use(express.static(path.resolve(&#x27;build&#x27;)));
app.use((req, res)=&gt;{
    res.sendFile(path.resolve(&#x27;./build/index.html&#x27;));
});
app.listen(port, ()=&gt;{
    console.log(`</span>listen on http:<span class="hljs-regexp">//</span>localhost:${port}<span class="hljs-string">`);
});</span></span></span>
</code></pre>

			<h3 id='frontend'>
				FrontEnd
			</h3>
		<p>in &#39;../src/app&#39;, the code is as below:</p>
<pre><code class="language-js"><span class="hljs-comment">//return a function to create a store, because every request need a new store</span>
<span class="hljs-keyword">const</span> store = <span class="hljs-function">()=&gt;</span>createStore(combineReducers(reducer), compose(
    applyMiddleware(thunk),
));
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">props</span>) </span>{
    <span class="hljs-keyword">return</span> (
        <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">Provider</span> <span class="hljs-attr">store</span>=<span class="hljs-string">{store()}</span>&gt;</span>
            {(()=&gt;{
                //this is for SSR
                if (props.env === &#x27;node&#x27;){
                    return (
                        <span class="hljs-tag">&lt;<span class="hljs-name">StaticRouter</span> <span class="hljs-attr">context</span>=<span class="hljs-string">{{}}</span> <span class="hljs-attr">location</span>=<span class="hljs-string">{props.url}</span>&gt;</span>
                            <span class="hljs-tag">&lt;<span class="hljs-name">Switch</span>&gt;</span>
                                <span class="hljs-tag">&lt;<span class="hljs-name">Route</span> <span class="hljs-attr">path</span>=<span class="hljs-string">{</span>&#x27;/<span class="hljs-attr">index</span>&#x27;} <span class="hljs-attr">component</span>=<span class="hljs-string">{Index}/</span>&gt;</span>
                                <span class="hljs-tag">&lt;<span class="hljs-name">Redirect</span> <span class="hljs-attr">to</span>=<span class="hljs-string">{</span>&#x27;/<span class="hljs-attr">index</span>&#x27;}/&gt;</span>
                            <span class="hljs-tag">&lt;/<span class="hljs-name">Switch</span>&gt;</span>
                        <span class="hljs-tag">&lt;/<span class="hljs-name">StaticRouter</span>&gt;</span>
                    )
                } else {
                    //this is for browser
                    return (
                        <span class="hljs-tag">&lt;<span class="hljs-name">BrowserRouter</span>&gt;</span>
                            <span class="hljs-tag">&lt;<span class="hljs-name">Switch</span>&gt;</span>
                            //Page is a dynamic router uses <span class="hljs-tag">&lt;<span class="hljs-name">Suspense</span>&gt;</span> and lazy(), so cannot be render in SSR
                                {Page(&#x27;/index&#x27;, &quot;index.page&quot;)}
                                {Page(&#x27;/sub1&#x27;, &quot;sub1.page&quot;)}
                                {Page(&#x27;/sub1&#x27;, &quot;sub2.page&quot;)}
                                <span class="hljs-tag">&lt;<span class="hljs-name">Redirect</span> <span class="hljs-attr">to</span>=<span class="hljs-string">{</span>&#x27;/<span class="hljs-attr">index</span>&#x27;}/&gt;</span>
                            <span class="hljs-tag">&lt;/<span class="hljs-name">Switch</span>&gt;</span>
                        <span class="hljs-tag">&lt;/<span class="hljs-name">BrowserRouter</span>&gt;</span>
                    )
                }
            })()}
        <span class="hljs-tag">&lt;/<span class="hljs-name">Provider</span>&gt;</span>
    )
};</span>
</code></pre>
<p>In server side, <code>&lt;BrowserRouter&gt;</code> cannot be used, use <code>&lt;StaticRouter&gt;</code> instead. The location property is imperative, without it, it will
render an empty page in server, and redirect in front end may lead to not SSR.</p>

			<h3 id='compile server code'>
				Compile server code
			</h3>
		<p>Obviously, this code cannot directly run in node.js, so we need to compile it. There is a webpack example:</p>
<pre><code class="language-js"><span class="hljs-keyword">const</span> path = <span class="hljs-built_in">require</span>(<span class="hljs-string">&#x27;path&#x27;</span>);

<span class="hljs-built_in">module</span>.exports = {
    <span class="hljs-attr">mode</span>: <span class="hljs-string">&#x27;development&#x27;</span>,
    <span class="hljs-attr">target</span>: <span class="hljs-string">&#x27;node&#x27;</span>,
    <span class="hljs-attr">entry</span>: {
        <span class="hljs-attr">static</span>:<span class="hljs-string">&quot;./server/static.js&quot;</span>
    },
    <span class="hljs-attr">output</span>: {
        <span class="hljs-attr">filename</span>: <span class="hljs-string">&#x27;[name].js&#x27;</span>,
        <span class="hljs-attr">path</span>: path.resolve(__dirname)
    },
    <span class="hljs-attr">module</span>: {
        <span class="hljs-attr">rules</span>: [{
            <span class="hljs-attr">test</span>: <span class="hljs-regexp">/\.(js|jsx)?$/</span>,
            exclude: <span class="hljs-regexp">/(node_modules)/</span>,
            use: [{
                <span class="hljs-attr">loader</span>: <span class="hljs-string">&#x27;babel-loader&#x27;</span>,
                <span class="hljs-attr">options</span>: {
                    <span class="hljs-attr">presets</span>: [<span class="hljs-string">&quot;@babel/preset-react&quot;</span>, <span class="hljs-string">&#x27;@babel/preset-env&#x27;</span>],
                }
            }],
        },{
            <span class="hljs-attr">test</span>: <span class="hljs-regexp">/\.(css|scss)?$/</span>,
            use: [<span class="hljs-string">&#x27;isomorphic-style-loader&#x27;</span>, {
                <span class="hljs-attr">loader</span>: <span class="hljs-string">&#x27;css-loader&#x27;</span>,
                <span class="hljs-attr">options</span>: {<span class="hljs-attr">modules</span>: <span class="hljs-literal">true</span>}
            }]
        }]
    }
};
</code></pre>

			<h2 id='end'>
				End
			</h2>
		<p>After compile server side code and frontend code, when we start the static files server, we can see <code>/</code> and <code>/index</code> has been render in server side.</p>
<p>This example does not consider about import images, svg and CSS framework. If you use some of CSS framework such as material-ui, you can find their SSR solution in the official website.</p>
<p>If you have more questions or have better way to do SSR, welcome to leave a message.</p>
</div>
		</div>
	</article></div></div></div></div>
	</div>
</body>

<script>
	const body = document.getElementsByClassName('markdown-body')[0];
	const initComments = () => {
		if (![
			'/',
			'/blog/index.html', 
			'/blog/code.html', 
			'/blog/leetcode.html', 
			'/blog/essay.html',
			'/blog/about.html'
		].includes(window.location.pathname)) {
			const root = document.createElement('div');
			root.id = 'fb-root';
			root.className = 'post-comments';
			const comments = document.createElement('div');
			comments.className = 'fb-comments';
			comments['data-href'] = window.location.href;
			comments['data-numposts'] = '5';
			root.appendChild(comments);
			body.appendChild(root);
		}
	};
	const changeComments = () => {
		const title = body.getElementsByTagName('h1')[0];
		if (title) {
			document.title = title.innerText;
		}
	};
	if (body) {
		changeComments();
		initComments();
	}
</script>
<script async defer crossorigin="anonymous" src="https://connect.facebook.net/en_US/sdk.js#xfbml=1&version=v9.0" nonce="BSCiWiHI"></script>

</html>